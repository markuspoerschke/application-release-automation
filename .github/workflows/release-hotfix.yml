name: Release Hotfix

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - closed

permissions:
  contents: read

jobs:
  add_comment:
    name: 'Add Comment to Hotfix PR'
    if: startsWith(github.event.pull_request.head.ref, 'hotfix/') && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add comment to PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **IMPORTANT**: This is a hotfix PR. Merging this PR will automatically create a release and deploy to production.'
            })

  create_hotfix_release:
    name: 'Create Hotfix Release'
    if: startsWith(github.event.pull_request.head.ref, 'hotfix/') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Release Variables
        id: vars
        run: |
          echo "version=$(TZ='Europe/Berlin' date +'%Y-%m-%d')-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.vars.outputs.version }}';

            const response = await github.rest.repos.createRelease({
              target_commitish: context.payload.pull_request.head.sha,
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              body: `## Hotfix Release ${version}\n\nThis is an automated hotfix release.`,
              draft: false,
              prerelease: false,
              generate_release_notes: false
            });

            console.log(`Created release: ${response.data.html_url}`);
